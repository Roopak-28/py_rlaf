name: Get from Pi
description: Fetches database instance data and outputs it as a JSON string.
inputs:
  - name: access_token
    type: string
  - name: base_url
    type: String
  - name: schema_id
    type: String
outputs:
  - name: db_data_json
    type: String
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        python3 -m pip install --quiet requests || \
        python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse, json, requests, os

        parser = argparse.ArgumentParser()
        parser.add_argument('--access_token', type=str, required=True)
        parser.add_argument('--base_url', type=str, required=True)
        parser.add_argument('--schema_id', type=str, required=True)
        parser.add_argument('--db_data_json', type=str, required=True)
        args = parser.parse_args()

        def get_instances(access_token, base_url, schema_id):
            instances_url = f"{base_url}/pi-entity-instances-service/v3.0/schemas/{schema_id}/instances/list"
            headers = {
                "Authorization": f"Bearer {access_token}",
                "Content-Type": "application/json"
            }
            payload = {
                "dbType": "TIDB",
                "ownedOnly": True,
                "filter": {
                    "id": "1"
                }
            }
            response = requests.post(instances_url, headers=headers, json=payload)
            response.raise_for_status()
            return response.json()

        db_data = get_instances(args.access_token, args.base_url, args.schema_id)

        os.makedirs(os.path.dirname(args.db_data_json), exist_ok=True)
        with open(args.db_data_json, 'w') as f:
            f.write(json.dumps(db_data))
        print(f"Database data fetched and written to {args.db_data_json}")
    args:
      - --access_token
      - { inputValue: access_token }
      - --base_url
      - { inputValue: base_url }
      - --schema_id
      - { inputValue: schema_id }
      - --db_data_json
      - { outputPath: db_data_json }
